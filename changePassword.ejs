<%- include('navbar') %>
<div id="change-password-container">
    <h2>Change Password</h2>
    <p class="instructions">Update your account password below.</p>

    <form id="changePasswordForm" action="/user/change-password" method="POST">
        <div class="form-group">
            <label for="email">Email Address</label>
            <input 
                type="email" 
                id="email"
                name="email" 
                placeholder="email@example.com" 
                required
                pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                title="Please enter a valid email address"
            >
            <div class="error-message" id="emailError"></div>
        </div>

        <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <input 
                type="password" 
                id="currentPassword"
                name="currentPassword" 
                required
                minlength="8"
            >
            <div class="error-message" id="currentPasswordError"></div>
        </div>

        <div class="form-group">
            <label for="newPassword">New Password</label>
            <input 
                type="password" 
                id="newPassword"
                name="newPassword" 
                required
                minlength="8"
                pattern="^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$"
            >
            <div class="password-requirements">
                Password must:
                <ul>
                    <li>Be at least 8 characters long</li>
                    <li>Contain at least one letter</li>
                    <li>Contain at least one number</li>
                </ul>
            </div>
            <div class="error-message" id="newPasswordError"></div>
        </div>

        <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input 
                type="password" 
                id="confirmPassword"
                name="confirmPassword" 
                required
                minlength="8"
            >
            <div class="error-message" id="confirmPasswordError"></div>
        </div>

        <div class="button-group">
            <button type="submit" class="submit-btn">Change Password</button>
            <a href="/" class="cancel-btn">Cancel</a>
        </div>

        <div id="globalError" class="error-message global-error"></div>
    </form>
</div>

<style>
    #change-password-container {
        max-width: 500px;
        margin: 40px auto;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .instructions {
        color: #666;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .form-group input:focus {
        outline: none;
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .password-requirements {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
    }

    .password-requirements ul {
        margin: 5px 0 0 20px;
        padding: 0;
    }

    .password-requirements li {
        margin: 3px 0;
    }

    .error-message {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
        display: none;
    }

    .global-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px;
        margin-top: 20px;
        border-radius: 4px;
        text-align: center;
    }

    .button-group {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }

    .submit-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        flex: 1;
        transition: background-color 0.2s;
    }

    .submit-btn:hover {
        background: #0056b3;
    }

    .submit-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .cancel-btn {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border-radius: 4px;
        text-decoration: none;
        text-align: center;
        flex: 1;
        transition: background-color 0.2s;
    }

    .cancel-btn:hover {
        background: #5a6268;
        text-decoration: none;
        color: white;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('changePasswordForm');
    const newPassword = document.getElementById('newPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const submitButton = document.querySelector('.submit-btn');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Reset error messages
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
        
        // Validate password match
        if (newPassword.value !== confirmPassword.value) {
            const confirmError = document.getElementById('confirmPasswordError');
            confirmError.textContent = 'Passwords do not match';
            confirmError.style.display = 'block';
            return;
        }

        // Validate password requirements
        const passwordRegex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
        if (!passwordRegex.test(newPassword.value)) {
            const newPasswordError = document.getElementById('newPasswordError');
            newPasswordError.textContent = 'Password must meet all requirements';
            newPasswordError.style.display = 'block';
            return;
        }

        try {
            submitButton.disabled = true;
            submitButton.textContent = 'Changing Password...';

            const response = await fetch('/user/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: document.getElementById('email').value,
                    currentPassword: document.getElementById('currentPassword').value,
                    newPassword: newPassword.value
                })
            });

            const data = await response.json();

            if (data.success) {
                const globalError = document.getElementById('globalError');
                globalError.style.backgroundColor = '#d4edda';
                globalError.style.borderColor = '#c3e6cb';
                globalError.style.color = '#155724';
                globalError.textContent = 'Password successfully changed. Redirecting...';
                globalError.style.display = 'block';

                setTimeout(() => window.location.href = '/', 2000);
            } else {
                throw new Error(data.message || 'Failed to change password');
            }
        } catch (error) {
            const globalError = document.getElementById('globalError');
            globalError.textContent = error.message || 'An error occurred. Please try again.';
            globalError.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = 'Change Password';
        }
    });

    // Enable/disable submit button based on form validity
    form.addEventListener('input', function() {
        submitButton.disabled = !form.checkValidity();
    });
});
</script>